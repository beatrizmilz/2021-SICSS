---
title: "Coletando dados digitais"
author: 
  - "Beatriz Milz"
  - "Juliana Brandão"
  - "Luana Calzavara"
  - "Nico Linares"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Fonte dos dados: Wikipedia

Parte 1: mudanças na página de wikipedia
Pergunta: tentar descobrir se existe um padrão nas alteracoes do verbete no wikipedia que reflita um contexto maior no país .

- https://pt.wikipedia.org/w/index.php?title=Discuss%C3%A3o:Jair_Bolsonaro&action=history

Parte 2: Discussão nas alteração

Objetivo: verificar temas discutidos, fazer uma análise de texto, topic model.

Pergunta: tentar descobrir se existe um padrão nas discussões que reflita um contexto maior no país .

- https://pt.wikipedia.org/wiki/Discuss%C3%A3o:Jair_Bolsonaro

- Inicialmente: Bolsonaro


## Parte 1

Tentativa 1:
- Encontramos um pacote chamado WikipediR, porém a documentação não apresenta exemplos e não é atualizado há 4 anos.

Tentativa 2: API 

https://pt.wikipedia.org/w/api.php



Tentativa 3: WS


## Coleta de dados

```{r eval=FALSE, include=TRUE}
library(magrittr, include.only = "%>%")

buscar_termos <- function(termo, limite = "10000") {
  # termo <- "Jair_Bolsonaro"
  # limite <- "20"
  
  
  url_wikipedia <-
    glue::glue(
      "https://pt.wikipedia.org/w/index.php?title={termo}&offset=&limit={limite}&action=history"
    )
  
  
  html <- rvest::read_html(url_wikipedia)
  
  itens <-
    rvest::html_node(html, xpath = '//*[@id="pagehistory"]') %>%
    rvest::html_nodes("li")
  

  buscar_classe <- function(lista, classe) {
    # lista <- itens
    # classe <- "secao_alterada"
    lista %>%
      purrr::map(~ rvest::html_nodes(.x, glue::glue("[class='{classe}']"))) %>%
      purrr::map(function(.x) {
        aux <- rvest::html_text(.x)
        if (length(aux) == 0) {
          return(NA_character_)
        } else {
          return(aux)
        }
      }) %>%
      purrr::as_vector()  # é aqui que ta dando problema
  }
  
  buscar_id <- function(lista) {
    lista %>% rvest::html_attr("data-mw-revid")
  }
  
  id <- buscar_id(itens)
  
  
  contribuidor <-
    itens %>%
    rvest::html_nodes("bdi") %>%
    rvest::html_text()
  
  data <- buscar_classe(itens, "mw-changeslist-date")
  #secao_alterada <- buscar_classe(itens, "autocomment")
  comentario <-
    buscar_classe(itens, "comment comment--without-parentheses")
  caracteres_removidos <-
    buscar_classe(itens, "mw-plusminus-neg mw-diff-bytes")
  caracteres_adicionados <-
    buscar_classe(itens, "mw-plusminus-pos mw-diff-bytes")
  tamanho_mudanca_bytes <-
    buscar_classe(itens, "history-size mw-diff-bytes")
  minor_edit <- buscar_classe(itens, "minoredit")
  
  
  tag <-
    buscar_classe(itens, "mw-tag-marker mw-tag-marker-visualeditor")
  

  tabela_suja <- tibble::tibble(
    id,
    contribuidor,
    data,
    # secao_alterada,
    comentario,
    caracteres_removidos,
    caracteres_adicionados,
    minor_edit,
    tag
  )
  
  tabela_suja
}


tabela_suja <- buscar_termos("Jair_Bolsonaro")
dplyr::glimpse(tabela_suja)

readr::write_rds(tabela_suja,
                 "dados/jair_bolsonaro_15-06-2021-dados_brutos.Rds")

## ARRUMAR

# arrumar as tags
#
# itens %>%
#   rvest::html_nodes("[class='mw-tag-markers']") %>% .[[1]]
# verificar os comentários que estão com NA

```

## Limpeza de dados

```{r echo=TRUE}
library(magrittr, include.only = "%>%")
tabela_suja <- readr::read_rds("dados/jair_bolsonaro_15-06-2021-dados_brutos.Rds")
dplyr::glimpse(tabela_suja)
```


```{r}
# tabela_suja %>% 
#   dplyr::mutate(data2 = readr::parse_datetime(data, format = "%Hh%Mmin de %d de %B de %Y"))
```


```{r}
tabela_suja %>% 
  dplyr::count(contribuidor, sort = TRUE)
```

## Métodos híbridos

- Ideia de rede: quem contribui na pagina do bolsonaro, contribui em quais paginas?
https://xtools.wmflabs.org/topedits/pt.wikipedia.org/Bageense/0


https://mittechreview.com.br/as-licoes-da-wikipedia-e-suas-limitacoes/


Outra ideia: Percepcao das pessoas usuárias, Experimento de vinheta: o quanto a pagina do wikipedia pode influenciar na percepcao das pessoas como ela ve o bolsonaro, o wikipedia, a colaboracao massiva?
