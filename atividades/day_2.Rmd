---
title: "Coletando dados digitais"
author: 
  - "Beatriz Milz"
  - "Luana Calzavara"
  - "Nico Linares"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Fonte dos dados: Wikipedia

Parte 1: mudanças na página de wikipedia
Pergunta: tentar descobrir se existe um padrão nas alteracoes do verbete no wikipedia que reflita um contexto maior no país .

- https://pt.wikipedia.org/w/index.php?title=Discuss%C3%A3o:Jair_Bolsonaro&action=history

Parte 2: Discussão nas alteração

Objetivo: verificar temas discutidos, fazer uma análise de texto, topic model.

Pergunta: tentar descobrir se existe um padrão nas discussões que reflita um contexto maior no país .

- https://pt.wikipedia.org/wiki/Discuss%C3%A3o:Jair_Bolsonaro

- Inicialmente: Bolsonaro


## Parte 1

Tentativa 1:
- Encontramos um pacote chamado WikipediR, porém a documentação não apresenta exemplos e não é atualizado há 4 anos.

Tentativa 2: API 

https://pt.wikipedia.org/w/api.php



Tentativa 3: WS



```{r echo=TRUE}

# quem fez a modificacao?
# id da modificacao
# data/hora
# quantos caracteres mudou


library(magrittr, include.only = "%>%")
url_wikipedia <- "https://pt.wikipedia.org/w/index.php?title=Jair_Bolsonaro&offset=&limit=10&action=history"


html <- rvest::read_html(url_wikipedia)

itens <- rvest::html_node(html, xpath = '//*[@id="pagehistory"]') %>% 
  rvest::html_nodes("li") 


buscar_classe <- function(lista, classe){
  lista %>%
  purrr::map( ~ rvest::html_nodes(.x, glue::glue("[class='{classe}']"))) %>%
  purrr::map( function(.x){
    aux <- rvest::html_text(.x)
    if(length(aux) == 0){
      return(NA_character_)
    } else {
      return(aux)
    }
  }) %>%
  purrr::as_vector()
} 

buscar_id <- function(lista){
  lista %>% rvest::html_attr("data-mw-revid")
}
  
id <- buscar_id(itens)
contribuidor <- buscar_classe(itens, "mw-userlink")
data <- buscar_classe(itens, "mw-changeslist-date")
secao_alterada <- buscar_classe(itens, "autocomment")
comentario <- buscar_classe(itens, "comment comment--without-parentheses") 
caracteres_removidos <- buscar_classe(itens, "mw-plusminus-neg mw-diff-bytes")
caracteres_adicionados <- buscar_classe(itens, "mw-plusminus-pos mw-diff-bytes")

tabela_suja <- tibble::tibble(id, 
                              contribuidor,
                              data,
                              secao_alterada,
                              comentario,
                              caracteres_removidos,
                              caracteres_adicionados)

dplyr::glimpse(tabela_suja)

```


